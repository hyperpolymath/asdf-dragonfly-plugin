#!/usr/bin/env bash
# SPDX-License-Identifier: PMPL-1.0-or-later
set -euo pipefail
source "$(dirname "${BASH_SOURCE[0]}")/../lib/utils.bash"
check_dependencies

[[ -z "${ASDF_INSTALL_VERSION:-}" ]] && fail "ASDF_INSTALL_VERSION required"
[[ -z "${ASDF_INSTALL_PATH:-}" ]] && fail "ASDF_INSTALL_PATH required"

dp="${ASDF_DOWNLOAD_PATH:-${ASDF_INSTALL_PATH}/tmp}"

if [[ ! -d "${dp}" ]] || [[ ! -f "${dp}/dragonfly" ]]; then
  mkdir -p "${dp}"
  log_info "Downloading dragonfly ${ASDF_INSTALL_VERSION}..."
  download_file "$(get_download_url "${ASDF_INSTALL_VERSION}")" "${dp}/dragonfly.tar.gz"
  tar -xzf "${dp}/dragonfly.tar.gz" -C "${dp}"
  rm "${dp}/dragonfly.tar.gz"
fi

mkdir -p "${ASDF_INSTALL_PATH}/bin"
# Find dragonfly binary (may be in subdirectory)
find "${dp}" -name "dragonfly" -type f -executable -exec cp {} "${ASDF_INSTALL_PATH}/bin/" \; 2>/dev/null || \
  cp "${dp}/dragonfly" "${ASDF_INSTALL_PATH}/bin/" 2>/dev/null || \
  cp "${dp}/"*/dragonfly "${ASDF_INSTALL_PATH}/bin/"
chmod +x "${ASDF_INSTALL_PATH}/bin/dragonfly"

[[ -d "${ASDF_INSTALL_PATH}/tmp" ]] && rm -rf "${ASDF_INSTALL_PATH}/tmp"
log_info "dragonfly ${ASDF_INSTALL_VERSION} installed"
